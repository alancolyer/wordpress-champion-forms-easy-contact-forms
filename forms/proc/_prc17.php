<?php switch ($phase->index) { case 4: $id = $fld->get('id'); $query = "SELECT CustomForms.ObjectOwner FROM #wp__easycontactforms_customformfields AS CustomFormFields  LEFT JOIN #wp__easycontactforms_customforms AS CustomForms  ON CustomFormFields.CustomForms = CustomForms.id WHERE CustomFormFields.id = '$id'"; $userid = EasyContactFormsDB::getValue($query); $user = EasyContactFormsClassLoader::getObject('Users', true, $userid); $uopts  = (object) array(); $uopts->Email = $user->get('email'); $uopts->FirstName = $user->get('Name'); $uopts->LastName = $user->get('Description'); echo json_encode($uopts); break; case 2: $id = $fld->get('id'); $query = "SELECT CustomForms.ObjectOwner FROM #wp__easycontactforms_customformfields AS CustomFormFields  LEFT JOIN #wp__easycontactforms_customforms AS CustomForms  ON CustomFormFields.CustomForms = CustomForms.id WHERE CustomFormFields.id = '$id'"; $userid = EasyContactFormsDB::getValue($query); if (!$userid) { return; } $user = EasyContactFormsClassLoader::getObject('Users', true, $userid); $uoptsxml = $user->isEmpty('Options') ? '<data></data>' : $user->get('Options'); $uoptsxml = simplexml_load_string($uoptsxml); if (isset($data->ChangeAccount)) { unset($uoptsxml->vcita); $uoptsxml->addChild('vcita'); } if (isset($data->UpdateStatus)) { $uoptsxml->UpdateStatus = 'true'; } else { unset($uoptsxml->UpdateStatus); } if (isset($data->Email) || isset($data->FirstName) || isset($data->LastName)) { if (!isset($uoptsxml->vcita)) { $uoptsxml->addChild('vcita'); } $uopts = $uoptsxml->vcita; $uopts->Email = isset($data->Email) ? $data->Email : $uopts->Email; $uopts->FirstName = isset($data->FirstName) ? $data->FirstName : $uopts->FirstName; $uopts->LastName = isset($data->LastName) ? $data->LastName : $uopts->LastName; $body = array(); $body['ref'] = 'EASYCONTACTFORM'; $body['email'] = (string) $uopts->Email; $body['first_name'] = urlencode((string) $uopts->FirstName); $body['last_name'] = urlencode((string) $uopts->LastName); global $wp_version; $request = array( 'body' => $body, 'user-agent' => 'WordPress/' . $wp_version . '; ' . get_bloginfo('url') ); $response = wp_remote_post('http://www.vcita.com/api/experts', $request); if (!is_wp_error($response)) { $response = @json_decode($response['body']); if (is_object($response)) { if ($response->success) { $uopts->FirstName = $response->first_name; $uopts->LastName = $response->last_name; $uopts->vcid = $response->id; if (!empty($response->confirmation_token)) { $uopts->ConfirmationToken = $response->confirmation_token; } $uopts->Error = ''; if ($response->confirmed) { $uopts->Confirmed = 'true'; } } else { $uopts->Email = ''; $uopts->Error = $response->error; } } else { $uopts->Email = ''; $uopts->Error = 'Cannot connect to vcita'; } } else { $uopts->Email = ''; $uopts->Error = 'Cannot connect to vcita'; } } $uoptsxml = $uoptsxml->asXML(); $user->set('Options', $uoptsxml); $user->save(); break; } ?>